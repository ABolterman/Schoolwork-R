---
title: "Stat 305 Lecture 7 dplyr Part 3 Exercises: `mutate`, `summarize,` the Pipe Operator `%>%`, and `n()`, with Modifications by Thomas Fiore"
author: "Solutions by Abigail Bolterman"
date:   "2022/09/27"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## External Requirements

For today's exercises, we'll need two new packages, `macleish` and `nasaweather`, in addition to `dplyr`, `ggplot2`, and `nycflights13`. Install the two new packages `macleish` and `nasaweather` in your console. 

```{r warning=FALSE, message=FALSE}
# load the library dplyr here
library(dplyr)
# load the library ggplot2 here
library(ggplot2)
# load the library nycflights13 here
library(nycflights13)
# in your console, install the package macleish
# do not install here
# load the library macleish here
library(macleish)
# in your console, install the package nasaweather
# do not install here
# load the library nasaweather here
library(nasaweather)
```

## Exercises

**Use the `flights` data set from `nycflights13` to answer each of the following.**

**1) Compare `air_time` with the difference `arr_time - dep_time`. What do you expect to see? What do you see? What do you need to do to fix it**.
```{r}
df = flights%>%
  mutate(arr_minus_dep = arr_time - dep_time) %>%
  select(air_time, arr_minus_dep)

knitr::kable(head(df))

```

Answer: I would expect there to be no difference between `air_time` and `arr_time - dep_time`. In actuality, the air_time is less than arr_time - dep_time because of the formatting of the data - dep_time and arr_time are in the format hhmm, so 0100 isn't 100 minutes, but 60, creating a disparity when subtracted. It also doesn't account for different time zones. To fix this, change all the local times to GMT, then convert the hours into minutes.


**2) Find the 10 most delayed flights at departure using a ranking function `min_rank()`. How do you want to handle ties? Carefully read the documentation for `min_rank()`.**
```{r}
df = flights %>%
  mutate(rank.delay=min_rank(desc(dep_delay))) %>%
  arrange(rank.delay) %>%
  select(year, month, day, flight, dep_delay, rank.delay)

knitr::kable(head(df,15))

```

Answer: `min_rank` is equivalent to `rank` but with `ties.method=min` preset. This keeps ties as ties instead of averaging them.

**3) Look at the number of cancelled flights per day. Is there a pattern? Is the proportion of cancelled flights related to the average departure delay?**.
```{r}

df = flights %>% 
  filter(is.na(dep_time)) %>%
  group_by(day) %>%
  summarize(total_flights_cancelled = n())

knitr::kable(df)

```

Answer: There's no obvious pattern of cancelled flights by day of the month.

```{r}
df = flights %>% 
  group_by(day) %>%
  summarize(proportion_cancelled = sum(is.na(dep_time)/length(dep_time)),
            average_delay = mean(dep_delay, na.rm=T))

knitr::kable(df, digits=3)
```

Answer: I don't see a pattern between proportion of flights cancelled and average departure delays by day of month.

**4) Come up with another approach that will give you the same output as**:
```{r}
not_cancelled <- flights %>% 
  filter(!is.na(dep_delay), !is.na(arr_delay))

#first output
not_cancelled %>% count(dest)

not_cancelled %>%
  group_by(dest) %>%
  summarize(n = n())


#second output
not_cancelled %>% count(tailnum, wt =distance)

not_cancelled %>%
  group_by(tailnum) %>%
  summarise(n = sum(distance))

```


**5) What does the `sort` argument of `count()` do. When might you use it?**

Answer: The `sort` argument of `count()` is similar to the `arrange` function, but on a different level. The `arrange` function sorts the original dataframe according to a variable in the original data frame. But the `sort` argument in `count` will sort the new data frame of summary counts by count.

Example:
```{r}
not_cancelled %>% count(month, sort=TRUE)
```


**6) The `macleish` package contains weather data collected every ten minutes in 2015 from two weather stations in Whately, MA. One data frame is called `whately_2015`, the other is called `orchard_2015`. Use `rbind` and `select` to create a new dataframe that takes `when` and `temperature` of both stations and stacks them, so you have two columns, the first rows are all from Whately, and the next rows are all from Orchard. Then create a column called `Key` that tells which rows are from which station. Then use `ggplot2`, to create a graph that displays the average temperature over each 10-minute interval (`temperature`) as a function of time (`when`), color coded by station (`Key`). Notice the `when` column is in a date-time format. Try if `ggplot2` can automatically handle that. **


```{r}
# for this we need the macleish package loaded 
# at the beginning in the External Requirements section

dfwhately = select(whately_2015, when, temperature)
dforchard = select(orchard_2015, when, temperature)

dfweather = rbind(dfwhately, dforchard)

dfweather$Key = c(rep("Whately Data", nrow(whately_2015)), 
                  rep("Orchard Data", nrow(orchard_2015)))

ggplot(dfweather, aes(x = when, y=temperature, color = Key)) +
  geom_line() +
  labs(title = "Average Temperature over 10 minute Intervals",
       subtitle = "Observations from 2 Stations in Whately, MA",
       x = "Date and Time",
       y = "Average Temperature in Celcius")

```

 **Which of the weather stations do you think made a mistake at some time?**
 
 Answer: Orchard station likely made a mistake in Dec 2015, where they had a reading of around -80 degrees Celsius, which is an unrealistic temperature, different from the surrounding Orchard data, and it is very different from the Whately reading.
 
 **7) Consider the `storms` data set in the `nasaweather` package. Use `geom_path` to plot the path of each tropical storm in the `storms` data frame. For `geom_path`, `x` and `y` should be the latitude and longitude. Use color to distinguish the storms from one another, and use faceting to plot each year in its own panel.**
 

```{r}
# for this we need the nasaweather package loaded 
# at the beginning in the External Requirements section

ggplot(storms, aes(x = lat, y = long, color = name))+
  geom_path()+
  facet_wrap(~year)+
  labs(title = "Path of Tropical Storms 1995-2000",
       x = "Latitude",
       y = "Longitude")+
  theme(legend.text = element_text(size=6))

```
 
 